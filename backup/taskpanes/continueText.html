<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本续写 - AI助手</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/taskpane.css">
</head>
<body>
    <div class="taskpane-container">
        <div class="taskpane-header">
            <h2 class="taskpane-title">文本续写</h2>
        </div>
        <div class="taskpane-content">
            <div class="section">
                <h3 class="section-title">选中内容</h3>
                <div class="text-display" id="selectedText">
                    <p class="placeholder">无选中内容</p>
                </div>
            </div>
            
            <div class="section">
                <h3 class="section-title">续写选项</h3>
                <div class="options-form">
                    <div class="form-group">
                        <label for="length">文本长度:</label>
                        <select id="length" class="select-field">
                            <option value="short">短</option>
                            <option value="medium" selected>中</option>
                            <option value="long">长</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="style">风格:</label>
                        <select id="style" class="select-field">
                            <option value="default" selected>默认</option>
                            <option value="formal">正式</option>
                            <option value="creative">创意</option>
                            <option value="academic">学术</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="temperature">创造性:</label>
                        <input type="range" id="temperature" min="0" max="10" value="7" class="range-field">
                        <div class="range-labels">
                            <span>保守</span>
                            <span>平衡</span>
                            <span>创新</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="btnGenerate" class="btn btn-primary">生成续写</button>
            </div>
            
            <div class="section" id="resultSection" style="display: none;">
                <h3 class="section-title">生成结果</h3>
                <div class="text-display" id="generatedText"></div>
                <div class="action-buttons">
                    <button id="btnInsert" class="btn btn-primary">插入文档</button>
                    <button id="btnRegenerateBtn" class="btn btn-secondary">重新生成</button>
                </div>
            </div>
            
            <div class="loading-indicator" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <p>正在生成续写内容...</p>
            </div>
        </div>
        <div class="taskpane-footer">
            <p>AI助手 v1.0.0</p>
        </div>
    </div>
    
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const selectedTextElem = document.getElementById('selectedText');
            const lengthSelect = document.getElementById('length');
            const styleSelect = document.getElementById('style');
            const temperatureRange = document.getElementById('temperature');
            const btnGenerate = document.getElementById('btnGenerate');
            const resultSection = document.getElementById('resultSection');
            const generatedTextElem = document.getElementById('generatedText');
            const btnInsert = document.getElementById('btnInsert');
            const btnRegenerate = document.getElementById('btnRegenerateBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // 存储选中的文本
            let selectedText = '';
            
            // 接收父页面消息
            window.addEventListener('message', function(event) {
                console.log('收到消息：', event.data);
                
                if (event.data && event.data.type === 'updateData') {
                    const data = event.data.data;
                    if (data && data.text) {
                        // 更新选中的文本
                        selectedText = data.text;
                        selectedTextElem.innerHTML = `<p>${escapeHtml(selectedText)}</p>`;
                        selectedTextElem.classList.remove('placeholder');
                    }
                }
            });
            
            // 生成续写按钮点击事件
            btnGenerate.addEventListener('click', function() {
                if (!selectedText) {
                    alert('请先选择一段文本作为续写的基础');
                    return;
                }
                
                // 显示加载指示器
                loadingIndicator.style.display = 'flex';
                resultSection.style.display = 'none';
                
                // 获取选项
                const options = {
                    length: lengthSelect.value,
                    style: styleSelect.value,
                    temperature: temperatureRange.value / 10
                };
                
                // 调用父页面的AI服务
                try {
                    // 尝试直接调用父窗口的aiService
                    if (window.parent && window.parent.aiService) {
                        window.parent.aiService.continueText(selectedText, options)
                            .then(handleResult)
                            .catch(handleError);
                    } 
                    // 如果直接调用失败，使用模拟数据
                    else {
                        console.log('使用模拟数据');
                        setTimeout(() => {
                            handleResult(window.parent.mockAiApi.continueText(selectedText));
                        }, 1500);
                    }
                } catch (error) {
                    // 发生错误时使用模拟数据
                    console.error('调用AI服务失败：', error);
                    setTimeout(() => {
                        handleResult({ 
                            text: selectedText + "这是模拟的续写内容。人工智能技术正在迅速发展，为各行各业带来了巨大的变革。在文档处理领域，AI可以帮助用户自动生成内容、校对文档、提取摘要等，大大提高了工作效率。" 
                        });
                    }, 1500);
                }
            });
            
            // 插入文档按钮点击事件
            btnInsert.addEventListener('click', function() {
                const generatedText = generatedTextElem.textContent;
                if (!generatedText) {
                    return;
                }
                
                try {
                    // 调用父窗口的文档操作方法
                    if (window.parent && window.parent.replaceSelectedText) {
                        window.parent.replaceSelectedText(generatedText);
                        // 更新选中文本
                        selectedText = generatedText;
                        selectedTextElem.innerHTML = `<p>${escapeHtml(selectedText)}</p>`;
                        // 隐藏结果区域
                        resultSection.style.display = 'none';
                    } else {
                        alert('无法访问文档对象');
                    }
                } catch (error) {
                    console.error('插入文档失败：', error);
                    alert('插入文档失败：' + error.message);
                }
            });
            
            // 重新生成按钮点击事件
            btnRegenerate.addEventListener('click', function() {
                btnGenerate.click();
            });
            
            // 处理API调用结果
            function handleResult(result) {
                loadingIndicator.style.display = 'none';
                
                if (result && result.text) {
                    generatedTextElem.textContent = result.text;
                    resultSection.style.display = 'block';
                } else {
                    alert('生成结果无效');
                }
            }
            
            // 处理API调用错误
            function handleError(error) {
                loadingIndicator.style.display = 'none';
                console.error('API调用失败：', error);
                alert('生成文本失败：' + (error.message || '未知错误'));
            }
            
            // HTML转义函数
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html> 