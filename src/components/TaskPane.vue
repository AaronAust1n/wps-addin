<template>
  <div class="taskpane-container">
    <div class="taskpane-header">
      <h2>WPS AI助手</h2>
    </div>
    <div class="taskpane-content">
      <div class="function-panel">
        <div class="function-item" @click="handleContinueText">
          <div class="icon">📝</div>
          <div class="title">文本续写</div>
          <div class="description">根据上下文智能续写文档内容</div>
        </div>
        <div class="function-item" @click="handleProofread">
          <div class="icon">✓</div>
          <div class="title">文本校对</div>
          <div class="description">检查并修正文档中的错误</div>
        </div>
        <div class="function-item" @click="handlePolish">
          <div class="icon">✨</div>
          <div class="title">文本润色</div>
          <div class="description">改进文档表达，使文章更专业</div>
        </div>
        <div class="function-item" @click="handleSummarize">
          <div class="icon">📋</div>
          <div class="title">文本摘要</div>
          <div class="description">为选定内容生成简洁摘要</div>
        </div>
        <div class="function-item" @click="handleSummarizeDoc">
          <div class="icon">📚</div>
          <div class="title">全文总结</div>
          <div class="description">分析整个文档并生成总结</div>
        </div>
      </div>
    </div>
    <div class="taskpane-footer">
      <div class="status-bar">
        <span>{{ statusMessage }}</span>
      </div>
      <div class="action-bar">
        <button @click="handleSettings" class="btn-settings">设置</button>
        <button @click="handleHelp" class="btn-help">帮助</button>
      </div>
    </div>
  </div>
</template>

<script>
import { ref } from 'vue'
import apiClient from './js/api.js'

export default {
  setup() {
    const statusMessage = ref('准备就绪')

    // 获取选中文本
    const getSelectedText = () => {
      try {
        const selection = window.Application.ActiveDocument.Range
        if (selection) {
          return selection.Text
        } else {
          window.Application.Alert('未选择任何文本')
          return null
        }
      } catch (e) {
        console.error('获取选中文本失败:', e)
        window.Application.Alert('获取选中文本失败: ' + e.message)
        return null
      }
    }

    // 获取整个文档文本
    const getDocumentText = () => {
      try {
        const doc = window.Application.ActiveDocument
        if (doc) {
          const range = doc.Range()
          return range.Text
        } else {
          window.Application.Alert('无法获取文档内容')
          return null
        }
      } catch (e) {
        console.error('获取文档内容失败:', e)
        window.Application.Alert('获取文档内容失败: ' + e.message)
        return null
      }
    }

    // 替换选中文本
    const replaceSelectedText = (newText) => {
      try {
        const selection = window.Application.ActiveDocument.Range
        if (selection) {
          selection.Text = newText
          return true
        }
        return false
      } catch (e) {
        console.error('替换文本失败:', e)
        window.Application.Alert('替换文本失败: ' + e.message)
        return false
      }
    }

    const getConfig = () => {
      if (window.Application && window.Application.PluginStorage) {
        const configStr = window.Application.PluginStorage.getItem('aiConfig')
        if (configStr) {
          try {
            return JSON.parse(configStr)
          } catch (e) {
            console.error('配置加载失败', e)
          }
        }
      }
      return null
    }

    const checkConfigured = () => {
      const config = getConfig()
      if (!config || !config.apiUrl) {
        window.Application.Alert('请先配置API设置')
        handleSettings()
        return false
      }
      return true
    }

    const handleContinueText = async () => {
      if (!checkConfigured()) return
      
      const selectedText = getSelectedText()
      if (!selectedText) return
      
      statusMessage.value = '执行文本续写...'
      
      try {
        // 更新API客户端配置
        const config = getConfig()
        apiClient.updateConfig(config)
        
        // 调用API续写文本
        const result = await apiClient.continueText(selectedText)
        
        // 将结果替换选中文本
        if (result) {
          const combinedText = selectedText + result
          replaceSelectedText(combinedText)
          statusMessage.value = '文本续写完成'
        }
      } catch (e) {
        statusMessage.value = '操作失败: ' + e.message
      }
    }

    const handleProofread = async () => {
      if (!checkConfigured()) return
      
      const selectedText = getSelectedText()
      if (!selectedText) return
      
      statusMessage.value = '执行文本校对...'
      
      try {
        // 更新API客户端配置
        const config = getConfig()
        apiClient.updateConfig(config)
        
        // 调用API校对文本
        const result = await apiClient.proofreadText(selectedText)
        
        // 将结果替换选中文本
        if (result) {
          replaceSelectedText(result)
          statusMessage.value = '文本校对完成'
        }
      } catch (e) {
        statusMessage.value = '操作失败: ' + e.message
      }
    }

    const handlePolish = async () => {
      if (!checkConfigured()) return
      
      const selectedText = getSelectedText()
      if (!selectedText) return
      
      statusMessage.value = '执行文本润色...'
      
      try {
        // 更新API客户端配置
        const config = getConfig()
        apiClient.updateConfig(config)
        
        // 调用API润色文本
        const result = await apiClient.polishText(selectedText)
        
        // 将结果替换选中文本
        if (result) {
          replaceSelectedText(result)
          statusMessage.value = '文本润色完成'
        }
      } catch (e) {
        statusMessage.value = '操作失败: ' + e.message
      }
    }

    const handleSummarize = async () => {
      if (!checkConfigured()) return
      
      const selectedText = getSelectedText()
      if (!selectedText) return
      
      statusMessage.value = '生成文本摘要...'
      
      try {
        // 更新API客户端配置
        const config = getConfig()
        apiClient.updateConfig(config)
        
        // 调用API生成摘要
        const result = await apiClient.summarizeText(selectedText)
        
        // 询问用户是否替换选中文本
        if (result) {
          if (window.Application.Confirm('摘要生成成功，是否替换选中文本？\n\n' + result)) {
            replaceSelectedText(result)
          }
          statusMessage.value = '文本摘要生成完成'
        }
      } catch (e) {
        statusMessage.value = '操作失败: ' + e.message
      }
    }

    const handleSummarizeDoc = async () => {
      if (!checkConfigured()) return
      
      const docText = getDocumentText()
      if (!docText) return
      
      statusMessage.value = '生成全文总结...'
      
      try {
        // 更新API客户端配置
        const config = getConfig()
        apiClient.updateConfig(config)
        
        // 调用API生成全文总结
        const result = await apiClient.summarizeDocument(docText)
        
        // 询问用户是如何处理结果
        if (result) {
          if (window.Application.Confirm('全文总结生成成功，是否插入到文档末尾？\n\n' + result)) {
            // 插入到文档末尾
            const selection = window.Application.ActiveDocument.Range
            selection.Collapse(false) // 折叠到末尾
            selection.InsertBefore('\n\n## 文档总结\n\n' + result + '\n')
          }
          statusMessage.value = '全文总结生成完成'
        }
      } catch (e) {
        statusMessage.value = '操作失败: ' + e.message
      }
    }

    const handleSettings = () => {
      if (window.Application) {
        window.Application.ShowDialog(
          window.Util.GetUrlPath() + window.Util.GetRouterHash() + '/dialog',
          'WPS AI助手 - 设置',
          450,
          600,
          false
        )
      }
    }

    const handleHelp = () => {
      window.open('https://example.com/ai-assistant-help', '_blank')
    }

    return {
      statusMessage,
      handleContinueText,
      handleProofread,
      handlePolish,
      handleSummarize,
      handleSummarizeDoc,
      handleSettings,
      handleHelp
    }
  }
}
</script>

<style scoped>
.taskpane-container {
  display: flex;
  flex-direction: column;
  height: 100vh;
  font-family: 'Microsoft YaHei', sans-serif;
}

.taskpane-header {
  padding: 15px;
  background-color: #4a86e8;
  color: white;
}

.taskpane-header h2 {
  margin: 0;
  font-size: 18px;
}

.taskpane-content {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}

.function-panel {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.function-item {
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 15px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.function-item:hover {
  background-color: #f5f5f5;
}

.function-item .icon {
  font-size: 24px;
  margin-bottom: 10px;
}

.function-item .title {
  font-weight: bold;
  margin-bottom: 5px;
}

.function-item .description {
  font-size: 12px;
  color: #666;
}

.taskpane-footer {
  border-top: 1px solid #eee;
  padding: 10px 15px;
}

.status-bar {
  font-size: 12px;
  color: #666;
  margin-bottom: 10px;
}

.action-bar {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

button {
  padding: 5px 10px;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}

.btn-settings {
  background-color: #f1f1f1;
  color: #333;
}

.btn-help {
  background-color: #e6e6e6;
  color: #333;
}
</style> 